<!doctype html><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ResizedImage</title>
<style>body{font-family:system-ui;margin:40px;max-width:900px} .box{border:1px solid #ddd;border-radius:12px;padding:16px}</style>
<h1>ResizedImage</h1>
<p>Free: 1 file ≤10MB. Pro: batch (≤50 files, ≤100MB each, ≤500MB total). No watermark.</p>
<div class="box">
  <label>Preset:
    <select id="preset">
      <option value='{"w":2000,"h":2000,"fmt":"jpeg","q":0.85}'>Amazon 2000×2000</option>
      <option value='{"w":2700,"h":2025,"fmt":"jpeg","q":0.85}'>Etsy 2700×2025</option>
      <option value='{"w":2048,"h":2048,"fmt":"jpeg","q":0.90}'>Shopify 2048×2048</option>
      <option value='{"w":1600,"h":1600,"fmt":"jpeg","q":0.80}'>eBay 1600×1600</option>
    </select>
  </label>
  <label><input id="keep" type="checkbox" checked> Fit inside (keep aspect)</label>
  <div style="margin:8px 0">
    <input id="file" type="file" accept="image/*" multiple>
  </div>
  <button id="buy">Unlock Pro ($2)</button>
  <button id="go">Process & Download</button>
  <div id="status"></div>
  <a id="manual" style="display:none" target="_blank" rel="noopener">Tap & hold to save (fallback)</a>
</div>
<script>
const $=id=>document.getElementById(id);
$('buy').onclick=()=>location.href='https://buy.stripe.com/test_cNi00bbCe5e1dKBdeh5os00';
async function isPro(){try{const r=await fetch('/me',{credentials:'include'});return (await r.json()).pro}catch{return false}}
async function redeem(){const t=new URLSearchParams(location.search).get('token');if(!t)return;
  const r=await fetch('/unlock?token='+encodeURIComponent(t),{credentials:'include'});
  const j=await r.json();if(j.ok){const u=new URL(location.href);u.searchParams.delete('token');history.replaceState({},'',u)}}
(async()=>{await redeem();if(await isPro()){$('buy').style.display='none'}})();
function isIOS(){return /iPad|iPhone|iPod/.test(navigator.userAgent)}
async function downloadSmart(blob, name, isZip){
  const a=$('manual'); a.style.display='none'; a.removeAttribute('href');
  if(isIOS()){
    if(!isZip){const fr=new FileReader();fr.onloadend=()=>{location.href=fr.result;a.href=fr.result;a.style.display='inline'};fr.readAsDataURL(blob);return}
    const url=URL.createObjectURL(blob); location.href=url; a.href=url; a.textContent='Open ZIP (Files)'; a.style.display='inline'; return;
  }
  const url=URL.createObjectURL(blob); const link=document.createElement('a'); link.href=url; link.download=name;
  document.body.appendChild(link); link.click(); setTimeout(()=>{document.body.removeChild(link);URL.revokeObjectURL(url)},500);
}
$('go').onclick=async()=>{
  const files=[...$('file').files]; if(!files.length){alert('Choose image(s)');return}
  const p=JSON.parse($('preset').value); const form=new FormData();
  files.forEach(f=>form.append('files',f)); form.append('w',p.w); form.append('h',p.h); form.append('fmt',p.fmt); form.append('q',p.q); form.append('keepAspect',$('keep').checked?'1':'0');
  $('status').textContent='Processing...';
  const res=await fetch('/process',{method:'POST',body:form,credentials:'include'}); if(!res.ok){$('status').textContent=await res.text();return}
  const ct=res.headers.get('Content-Type')||''; const isZip=ct.includes('zip'); const blob=await res.blob();
  const name=isZip?`resized_${Date.now()}.zip`:`resized.${p.fmt==='png'?'png':'jpg'}`; await downloadSmart(blob,name,isZip); $('status').textContent='Done.';
};
</script>
